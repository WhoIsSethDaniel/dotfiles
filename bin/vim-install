#!/bin/bash

set -e 

DL="https://github.com/neovim/neovim/releases/download/nightly/nvim-linux64.tar.gz"
SUM_EXT="sha256sum"
SUM_NAME="nvim."$SUM_EXT
SUM=$DL"."$SUM_EXT
STORE=$XDG_DATA_HOME"/nvim"

rmtmpdir() {
    [[ -n $tmpdir ]] && rm -rf "$tmpdir"
}

tmpdir=$(mktemp -q -d --tmpdir install-nvim.XXXXXXX)
trap rmtmpdir EXIT

cd "$tmpdir" || exit
curl -LSo "$SUM_NAME" "$SUM"

OLD_SUM=${STORE}${SUM_NAME}
if [[ -e "$OLD_SUM" ]] ; then
    OLD=$(cat "$OLD_SUM")
    NEW=$(cat "${tmpdir}/${SUM_NAME}")
    if [[ "$NEW" == "$OLD" ]] ; then
        echo "no update available"
        exit 0
    fi
fi

curl -LSo nvim.tar.gz "$DL"

cd ~/lib || exit
rm -rf nvim

tar xzvf "$tmpdir"/nvim.tar.gz
mv nvim-linux64 nvim

# only do this if everything else succeeds
cp --force "${tmpdir}/${SUM_NAME}" "$STORE/."
