#!/bin/bash

set -e

# DL="https://github.com/neovim/neovim/releases/download/nightly/nvim-linux64.tar.gz"
DL="https://github.com/neovim/neovim/releases/download/v0.7.0/nvim-linux64.tar.gz"
SUM_EXT="sha256sum"
SUM_NAME="nvim."$SUM_EXT
SUM=$DL"."$SUM_EXT
STORE=$XDG_DATA_HOME"/nvim"

rmtmpdir() {
    [[ -n $tmpdir ]] && rm -rf "$tmpdir"
}

tmpdir=$(mktemp -q -d --tmpdir install-nvim.XXXXXXX)
trap rmtmpdir EXIT

cd "$tmpdir" || exit
curl -LSo "$SUM_NAME" "$SUM"

OLD_SUM=${STORE}"/"${SUM_NAME}
if [[ -e $OLD_SUM ]]; then
    OLD=$(cut -d\  -f1 "${OLD_SUM}")
    NEW=$(cut -d\  -f1 "${tmpdir}/${SUM_NAME}")
    echo "old: ${OLD}"
    echo "new: ${NEW}"
    if [[ $NEW == "$OLD" ]]; then
        echo "no update available"
        exit 0
    else
        echo "update available"
    fi
else
    echo "no old sum found"
fi

curl -LSo nvim.tar.gz "$DL"

cd ~/.local || exit
rm -rf nvim

tar xzvf "$tmpdir"/nvim.tar.gz
mv nvim-linux64 nvim

# only do this if everything else succeeds
cp --force "${tmpdir}/${SUM_NAME}" "$STORE/."
